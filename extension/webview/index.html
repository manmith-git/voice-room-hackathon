<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Voice Room â€” VS Code</title>
    <style>
      body {
        font-family: system-ui, Segoe UI, Roboto, Arial;
        padding: 12px;
        background: #0f172a;
        color: #e6eef8;
      }
      .card {
        background: #0b1220;
        padding: 12px;
        border-radius: 10px;
        margin-bottom: 10px;
        box-shadow: 0 6px 18px rgba(2, 6, 23, 0.6);
      }
      input,
      button {
        padding: 8px;
        border-radius: 6px;
        border: 1px solid #263244;
        background: #071026;
        color: #e6eef8;
      }
      .row {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      #members {
        margin-top: 8px;
      }
      .member {
        display: flex;
        justify-content: space-between;
        padding: 6px;
        border-radius: 6px;
        background: #071428;
        margin-bottom: 6px;
      }
    </style>
  </head>
  <body>
    <h2>Voice Room â€” VS Code</h2>
    <div class="card">
      <div class="row">
        <input id="name" placeholder="Enter your name" />
        <input id="room" placeholder="room code (or create)" />
        <button id="createBtn">Create Room</button>
        <button id="joinBtn">Join Room</button>
        <button id="openMicBtn">Open Mic (browser)</button>
      </div>
      <div id="status" style="margin-top: 8px">Status: idle</div>
    </div>

    <div class="card">
      <h3>Members</h3>
      <div id="members">No members</div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script type="module">
      import * as Y from "https://voice-room-hackathon.onrender.com/lib/yjs.mjs";
      window.Y = Y;
    </script>

    <script src="https://voice-room-hackathon.onrender.com/lib/y-webrtc.js"></script>

    <script>
      const SIGNALING = "https://voice-room-hackathon.onrender.com";
      const socket = io(SIGNALING, { transports: ["websocket"] });

      const userId = "user-" + Math.random().toString(36).slice(2, 9);
      let roomCode = "";
      let provider, ydoc, awareness;

      function setStatus(s) {
        document.getElementById("status").textContent = "Status: " + s;
      }

      document.getElementById("createBtn").onclick = () => {
        const name = document.getElementById("name").value || "Anon";
        roomCode = Math.random().toString(36).slice(2, 8);
        startJoin(roomCode, name, true);
      };
      document.getElementById("joinBtn").onclick = () => {
        const name = document.getElementById("name").value || "Anon";
        roomCode = document.getElementById("room").value.trim();
        if (!roomCode) return alert("enter room");
        startJoin(roomCode, name, false);
      };
      document.getElementById("openMicBtn").onclick = () => {
        const name = document.getElementById("name").value || "Anon";
        // ask extension host to open mic helper
        if (window.acquireVsCodeApi) {
          const vscode = acquireVsCodeApi();
          vscode.postMessage({
            type: "open-mic",
            room: roomCode,
            userId,
            displayName: name,
          });
        } else {
          // open directly in browser (for web client)
          const url =
            "/mic-helper/index.html?room=" +
            encodeURIComponent(roomCode) +
            "&userId=" +
            encodeURIComponent(userId) +
            "&name=" +
            encodeURIComponent(name);
          window.open(url, "_blank");
        }
      };

      socket.on("room-peers", (peers) => {
        console.log("peers", peers);
      });

      socket.on("peer-joined", (meta) => {
        addMemberLine(meta.userId, meta.displayName, meta.role);
      });

      socket.on("peer-left", ({ id, userId }) => {
        removeMemberBySocket(id, userId);
      });

      function startJoin(room, name, isCreator) {
        setStatus("joining " + room);
        socket.emit("join-room", {
          room,
          userId,
          displayName: name,
          role: "vscode",
        });

        // initialize Yjs + y-webrtc
        ydoc = new Y.Doc();
        provider = new window.ywebrtc.WebrtcProvider(room, ydoc, { signaling: [SIGNALING] });

        awareness = provider.awareness;
        awareness.setLocalState({
          user: { userId, displayName: name, role: "vscode", micMuted: true },
        });
        awareness.on("update", renderMembers);

        // request existing files via extension host (extension will call workspace fs)
        const vscode = window.acquireVsCodeApi ? acquireVsCodeApi() : null;
        if (vscode) {
          // ask extension to send file contents for initial sync (extension should implement)
          vscode.postMessage({ type: "request-initial-files" });
        }

        setStatus("joined " + room);
      }

      function renderMembers() {
        const out = [];
        const states = awareness.getStates();
        states.forEach((st) => {
          if (st && st.user) out.push(st.user);
        });
        const el = document.getElementById("members");
        if (out.length === 0) el.innerHTML = "No members";
        else el.innerHTML = "";
        out.forEach((u) => {
          const div = document.createElement("div");
          div.className = "member";
          div.innerHTML =
            "<div>" +
            (u.displayName || u.userId) +
            " <small>(" +
            (u.role || "") +
            ")</small></div><div>" +
            (u.micMuted ? "ðŸ”‡" : "ðŸŽ¤") +
            "</div>";
          el.appendChild(div);
        });
      }

      function addMemberLine(userId_, name_, role_) {
        /* placeholder: Yjs awareness will show them */
      }

      function removeMemberBySocket(sockId, userId_) {
        // best-effort: remove by userId
        const el = document.getElementById("members");
        Array.from(el.children).forEach((ch) => {
          if (ch.textContent.includes(userId_)) ch.remove();
        });
      }

      // handle messages from extension host (VS Code)
      window.addEventListener("message", (ev) => {
        const msg = ev.data;
        if (msg.type === "file-content") {
          // extension sent file content - push into Yjs doc or handle appropriately
          console.log("file content", msg.path);
          // For demo: we don't automatically write file contents to workspace here.
        } else if (msg.type === "local-file-change") {
          // broadcast change into Yjs or via provider; omitted for brevity
        }
      });
    </script>
  </body>
</html>
